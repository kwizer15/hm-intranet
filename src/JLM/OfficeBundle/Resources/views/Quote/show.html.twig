{% extends "JLMOfficeBundle::layout.html.twig" %}

{% block content %}
<h1>Devis <small>{{ entity.number }}</small></h1>
<div class="alert{% if entity.state == 0 %}">
<h4>En saisie</h4>
{% elseif entity.state == 1 %}">
<h4>Prêt à être envoyé</h4>
{% elseif entity.state == 2 %}">
<h4>Imprimé (prêt à faxer)</h4>
{% elseif entity.state == 3 %} alert-info">
<h4>Envoyé (en attente de l'accusé)</h4>
{% elseif entity.state == 4 %} alert-info">
<h4>Envoyé</h4>
{% elseif entity.state == 5 %} alert-success">
<h4>Accordé</h4>
{% else %} alert-error">
<h4>Annulé</h4>
{% endif %}
</div>
<div class="row-fluid">
    <div class="span5">
    	<strong>Créé le {{ entity.creation|date('d/m/Y') }}
    	<br>par {{ entity.followerCp }}</strong>
        <br><br>{{ entity.doorCp | nl2br }}

    </div>
    <div class="span5 offset2 well">
    	<strong>Facturation</strong>
        <br>{{ entity.trusteeName }}
        <br>{{ entity.trusteeAddress | nl2br  }}
        <br>
        <br>à l'attention de {{ entity.contactCp }}
    </div>
</div>

<div class="form-actions">
	<a href="{{ path('quote') }}" class="btn"><i class="icon-arrow-left"></i> Retour à la liste</a>
	{% if entity.state == 0 %}
	<a href="{{ path('quote_edit', { 'id': entity.id }) }}" class="btn btn-warning"><i class="icon-pencil icon-white"></i> Editer</a>
	{% endif %}
	<a href="{{ path('variant_new',{ 'id' : entity.id }) }}" class="btn btn-success"><i class="icon-plus-sign icon-white"></i> Ajouter une variante</a>
	</div>


<ul id="variants" class="nav nav-tabs">
	{% for variant in entity.variants %}
    <li{% if loop.first %} class="active"{% endif %}>
        <a href="#variant-{{ variant.number }}" data-toggle="tab">{{ variant.number }}
        {% if variant.state == 0 %}
		<span class="label">En saisie</span>
		{% elseif variant.state == 1 %}
		<span class="label label-warning">Validé</span>
		{% elseif variant.state == 2 %}
		<span class="label label-warning">Imprimé</span>
		{% elseif variant.state == 3 %}
		<span class="label label-info">Envoyé*</span>
		{% elseif variant.state == 4 %}
		<span class="label label-info">Envoyé</span>
		{% elseif variant.state == 5 %}
		<span class="label label-success">Accordé</span>
		{% else %}
		<span class="label label-inverse">Annulé</span>
		{% endif %}
         </a>
    </li>
    {% endfor %}
</ul>
{%  if entity.variants | length %}
<div id="variantsContent" class="tab-content">
{% for variant in entity.variants %}
    <div class="tab-pane fade{% if loop.first %} active in{% endif %}" id="variant-{{ variant.number }}">
	<strong>Créé le {{ entity.creation|date('d/m/Y') }}</strong>
    <p>{{ variant.intro }}</p>
  	<ul class="nav nav-pills">
	  <li class="active tab-quote"><a href="#">Devis</a></li>
	  <li class="tab-coding"><a href="#">Chiffrage</a></li>
	</ul>
    <table class="table table-bordered">
    <thead>
        <tr>
            <th class="col-quote">Réf.</th>
            <th>Designation</th>
            <th>Qté</th>
            <th class="col-coding">PA HT</th>
   			<th class="col-coding">Remise</th>
    		<th class="col-coding">Frais</th>
    		<th class="col-coding">Port</th>
            <th class="col-quote">Prix U.H.T</th>
            <th class="col-quote">Remise</th>
            <th>Prix H.T</th>
            <th class="col-quote">T.V.A</th>
        </tr>
    </thead>
    <tbody>
    {% for line in variant.lines %}
         <tr>
            <td class="col-quote">{{ line.reference }}</td>
            <td>
                {{ line.designation }}
                {% if line.showDescription %}
                <br><em>{{ line.description|nl2br }}</em>
                {% endif %}
            </td>
            <td>{{ line.quantity }}</td>
            <td class="col-coding">{{ line.purchasePrice|number_format(2,',',' ') }} €</th>
   			<td class="col-coding">{{ line.discountSupplier*100|number_format(0,',',' ') }} %</th>
    		<td class="col-coding">{{ line.expenseRatio*100|number_format(0,',',' ') }} %</th>
    		<td class="col-coding">{{ line.shipping|number_format(2,',',' ') }} €</th>
            <td class="col-quote">{{ line.unitPrice|number_format(2,',',' ') }} €</td>
            <td class="col-quote">{{ (line.discount*100)|number_format(0,',',' ') }} %</td>
            <td>{{ line.price|number_format(2,',',' ') }} €</td>
            <td class="col-quote">{{ (line.vat*100)|number_format(1,',',' ') }} %</td>
       </tr>  
    {% endfor %}
    </tbody>
</table>

<div class="row-fluid">
	<div class="span8">
		<dl>
			<dt>Règlement</dt>
			<dd>{{ variant.paymentRules }}</dd>
			<dt>Délais</dt>
			<dd>{{ variant.deliveryRules }}</dd>
		</dl>
	</div>
   <div class="span4">
    <table class="table table-bordered">
    	<tbody>
    		<tr>
    			<th>Remise</th>
    			<td>{{ variant.discount*100|number_format(2,',',' ') }} %</td>
    		</tr>
    		<tr class="info">
    			<th>Total H.T.</th>
    			<td>{{ variant.totalPrice|number_format(2,',',' ') }} €</td>
    		</tr>
    		<tr class="col-coding">
    			<th>Total achat</th>
    			<td>{{ variant.totalPurchase|number_format(2,',',' ') }} €</td>
    		</tr>
    		<tr class="col-coding">
    			<th>Total marge</th>
    			<td>{{ variant.totalMargin|number_format(2,',',' ') }} €</td>
    		</tr>
     		<tr class="col-quote">
    			<th>Total TVA</th>
    			<td>{{ variant.totalVat|number_format(2,',',' ') }} €</td>
    		</tr>
    		<tr class="col-quote">
    			<th>Total à régler</th>
    			<td>{{ variant.totalPriceAti|number_format(2,',',' ') }} €</td>
    		</tr>
    	</tbody>
    </table>
    </div>
</div> 
<div class="form-actions">

	{% if variant.state == 4 %}
		<a href="{{ path('quote_given', { 'id': entity.id }) }}" class="btn btn-success"><i class="icon-thumbs-up icon-white"></i> Accorder</a>
	{% endif %}
	{% if variant.state > 0 and variant.state < 5%}
		<a href="{{ path('quote_unvalid', { 'id': entity.id }) }}" class="btn btn-inverse"><i class="icon-remove icon-white"></i> Invalider</a>
	{% endif %}
	{% if variant.state > 0 %}
		<a href="{{ path('quote_mail', { 'id': entity.id }) }}" class="btn btn-info"><i class="icon-envelope icon-white"></i> Envoyer par e-mail</a>
		<a href="{{ path('quote_pdf', { 'id': entity.id }) }}" class="btn btn-primary"><i class="icon-print icon-white"></i> Imprimer</a>
	{% endif %}
	{% if variant.state == 0 %}
		<a href="{{ path('quote_edit', { 'id': entity.id }) }}" class="btn btn-warning"><i class="icon-pencil icon-white"></i> Editer</a>
	{% endif %}
	</div>

</div>
{% endfor %}
</div>
{% else %}
<p>Pas encore de devis</p>
{% endif %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset("bundles/jlmoffice/js/quote.js") }}"></script>
<script>
$("body").quotevariant();
</script>
{% endblock %}