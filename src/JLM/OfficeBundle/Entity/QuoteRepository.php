<?php

namespace JLM\OfficeBundle\Entity;

use JLM\ModelBundle\Entity\Door;
use JLM\DefaultBundle\Entity\SearchRepository;

/**
 * QuoteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class QuoteRepository extends SearchRepository
{
    public function getLastModified()
    {
        $qb = $this->createQueryBuilder('a')
            ->select('MAX(b.lastModified)')
               ->leftJoin('a.variants','b');
        return new  \DateTime($qb->getQuery()->getSingleScalarResult());
        
    }
    
	public function getById($id)
	{
		$qb = $this->createQueryBuilder('a')
			->select('a')
			->leftJoin('a.door','b')
			->leftJoin('b.site','c')
			->leftJoin('c.address','d')
			->leftJoin('d.city','e')
			->leftJoin('b.type','f')
			->leftJoin('a.contact','g')
			->leftJoin('a.contactPerson','h')
			->leftJoin('a.variants','i')
			->leftJoin('i.lines','j')
			->where('a.id = ?1')
			
			->setParameter(1, $id);
		
		return $qb->getQuery()->getSingleResult();
	}
	
	public function getTotal()
	{
		return $this->getCountState();
	}
	
	public function getLastNumber()
	{
		$date = new \DateTime;
		$year = $date->format('Y');
		$qb = $this->createQueryBuilder('q')
			->select('SUBSTRING(q.number,5) as num')
			->where('SUBSTRING(q.creation, 1, 4) = :year')
			->orderBy('q.number','DESC')
			->setMaxResults(1)
			->setParameter('year',$year);
		$result = $qb->getQuery()->getResult();
//		var_dump($result); exit;
		if (!$result)
			return 0;
		else
			return $result[0]['num'];
	}
	
	/**
	 * 
	 * @deprecated
	 */
	public function searchold($query)
	{
		$query = str_replace(array('-1','-2','-3','-4','-5'),'',$query);
		$qb = $this->createQueryBuilder('q')
//				->select('q,v')
//				->leftJoin('q.variants','v')
				->where('q.followerCp LIKE :query')
				->orWhere('q.number LIKE :query')
				->orWhere('q.trusteeName LIKE :query')
				->orWhere('q.trusteeAddress LIKE :query')
				->orWhere('q.doorCp LIKE :query')
				->orWhere('q.contactCp LIKE :query')
				->orWhere('q.followerCp LIKE :query')
				->orderBy('q.creation','DESC')
				->setParameter('query', '%'.$query.'%');
		
		return $qb->getQuery()->getResult();
	}
	
	/**
	 * {@inheritdoc}
	 */
	protected function getSearchQb()
	{
		return $this->createQueryBuilder('a');
	}
	
	/**
	 * {@inheritdoc}
	 */
	protected function getSearchParams()
	{
		return array('a.number','a.trusteeName','a.trusteeAddress','a.doorCp','a.contactCp');
	}
	
	/**
	 * {@inheritdoc}
	 */
	protected function getSearchOrderBy()
	{
		return array('a.number'=>'DESC');
	}

	public function getCountState($state = null, $year = null)
	{
		if (!isset($this->countState[$year]))
		{
			$year = ($year === null) ? 'total' : $year;
			$qb = $this->createQueryBuilder('a')
				->select('a,b,c')
				->leftJoin('a.variants','b')
				->leftJoin('a.contactPerson','c')
				;
			if ($year !== 'total')
			{
				$qb->where('a.creation BETWEEN :fd AND :ld')
					->setParameter('fd', $year.'-01-01')
					->setParameter('ld', $year.'-12-31')
				;
			}

			$result = $qb->getQuery()->getResult();
			$this->countState[$year] = array(0=>0, 1=>0, 2=>0, 3=>0, 4=>0, 5=>0);
			$this->total[$year] = 0;
			$this->uncanceled[$year] = 0;
			foreach ($result as $r)
			{
				if (!isset($this->countState[$year][$r->getState()]))
					$this->countState[$year][$r->getState()] = 0;
				switch ($r->getState())
				{
					case 1:
					case 2:
						$this->countState[$year][1]++;
						$this->countState[$year][2]++;
						break;
					case 3:
					case 4:
						$this->countState[$year][3]++;
						$this->countState[$year][4]++;
						break;
					default:
						$this->countState[$year][$r->getState()]++;
				}
				if ($r->getState() >= 0)	// On retire les devis annulÃ©s
					$this->uncanceled[$year]++;
				$this->total[$year]++;
			}
		}
		if ($state === 'uncanceled')
			return $this->uncanceled[$year];
		if ($state === null)
			return $this->total[$year];
		return $this->countState[$year][$state];
	}
	
	public function getByState($state,$limit,$offset)
	{
		if (isset($this->byState))
			return $this->byState;
		
		if ($state == 1 || $state == 2)
			$state = array(1,2);
		elseif ($state == 3 || $state == 4)
			$state = array(3,4);
		else
			$state = array($state);
		$qb = $this->createQueryBuilder('a')
				->select('a,b,c,d,e,f,g,h')
				->leftJoin('a.door','b')
				->leftJoin('b.site','c')
				->leftJoin('c.address','d')
				->leftJoin('d.city','e')
				->leftJoin('b.type','f')
				->leftJoin('a.contact','g')
				->leftJoin('a.contactPerson','h')
				->orderBy('a.number','desc')
		;
		$results = $qb->getQuery()->getResult();
		$quotes = array();
		foreach ($results as $key=>$r)
			if (in_array($r->getState(),$state))
				if ($offset)
				{
					unset($results[$key]);
					$offset--;
				}
				elseif (!$limit)
					unset($results[$key]);
				else 
					$limit--;
			else
				unset($results[$key]);
		$this->byState = $results;
		return $results;
	}
	
	public function getAll($limit = null,$offset = null)
	{
		$qb = $this->createQueryBuilder('a')
			->select('a,b,c,d,e,f')
			->leftJoin('a.door','b')
			->leftJoin('b.site','c')
			->leftJoin('c.address','d')
			->leftJoin('d.city','e')
			->leftJoin('b.type','f')
			->orderBy('a.number','desc');
		if ($limit !== null)
		{
			$qb->setMaxResults($limit);
		}
		if ($offset !== null)
		{
			$qb->setFirstResult($offset);
		}
		return $qb->getQuery()->getResult();
	}
	
	public function getByDoor(Door $door)
	{
		$qb = $this->createQueryBuilder('a')
			->select('a')
			->leftJoin('a.door','b')
			->where('b.id = ?1')
			->orderBy('a.creation','desc')
			->setParameter(1,$door->getId());
		return $qb->getQuery()->getResult();
			
	}

}