{% extends "JLMDefaultBundle::layout.html.twig" %}

{% block container %}
<div class="page-header">
  <h1>Tableau de bord (beta)</h1>
</div>
<div class="row">
  <div class="col-md-6">
    <h2>Contrats</h2>
    <blockquote>
      {{ contracts_numbers }} contrats en cours sur {{ contracts_doors }} installations.<br>
      {{ contracts_complete }} installations en contrats complet<br>
      {{ contracts_normal }} installations en contrats normal
    </blockquote>
  
	<h2>Quantité</h2>	
    <table class="table table-bordered">
      <thead>
        <tr>
          <th></th>
          <th>Dépannages</th>
          <th>Travaux</th>
          <th>Entretiens</th>
          <th>Atl / Frn</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
      {% for tech, datas in numbers if tech != 'total' %}
        <tr>
          <th>{{ tech }}</th>
          <td class="text-right">{{ datas.fixing }}</td>
          <td class="text-right">{{ datas.work }}</td>
          <td class="text-right">{{ datas.maintenance }}</td>
          <td class="text-right">{{ datas.equipment }}</td>
          <td class="text-right">{{ datas.total }}</td>
        </tr>
      {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th class="text-right">{{ numbers.total.fixing }}</th>
          <th class="text-right">{{ numbers.total.work }}</th>
          <th class="text-right">{{ numbers.total.maintenance }}</th>
          <th class="text-right">{{ numbers.total.equipment }}</th>
          <th class="text-right">{{ numbers.total.total }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="col-md-6">
    <h2>Temps</h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th></th>
          <th>Dépannages</th>
          <th>Travaux</th>
          <th>Entretiens</th>
          <th>Atl / Frn</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
      {% for tech, datas in times if tech != 'total' %}
        <tr>
          <th>{{ tech }}</th>
          <td class="text-right">{{ datas.fixing.format('%hh%I') }}</td>
          <td class="text-right">{{ datas.work.format('%hh%I') }}</td>
          <td class="text-right">{{ datas.maintenance.format('%hh%I') }}</td>
          <td class="text-right">{{ datas.equipment.format('%hh%I') }}</td>
          <td class="text-right">{{ datas.total.format('%hh%I') }}</td>
        </tr>
      {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th class="text-right">{{ times.total.fixing.format('%hh%I') }}</th>
          <th class="text-right">{{ times.total.work.format('%hh%I') }}</th>
          <th class="text-right">{{ times.total.maintenance.format('%hh%I') }}</th>
          <th class="text-right">{{ times.total.equipment.format('%hh%I') }}</th>
          <th class="text-right">{{ times.total.total.format('%hh%I') }}</th>
        </tr>
      </tfoot>
    </table>
    <div id="graphTech"></div>
  </div>
</div>
<div class="row">
  <div class="col-md-6">
    <h2>Entretiens</h2>
    <div id="graphEvolution"></div>
  </div>
  <div class="col-md-6">
     <h2>Taux d'entretiens</h2>
     <div id="graphMaintenance"></div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
$(function () {
	// Build the chart
    $('#graphTech').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: 'Temps passé par type d\'intervention'
        },
        tooltip: {
        	formatter : function(){
                return this.point.name + ': <b>' + Math.round(this.point.y/60) + 'h' + this.point.y%60 + '</b>';
            }  
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    formatter: function() {
                    	return '<b>'+ this.point.name +'</b>: '+ Math.round(this.percentage*100)/100 +' %';
                    }
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'Temps passé',
            data: [
                {
                    name : 'Dépannages',
                    color : '#f89406', 
                    y : {{ times.total.fixing.format('%h')*60+times.total.fixing.format('%i') }}
                },
                {
                    name : 'Travaux',
					color : '#3a87ad',
                    y : {{ times.total.work.format('%h')*60+times.total.work.format('%i') }}
                },
                {
                    name : 'Entretiens',
                    color : '#999999',
                    y : {{ times.total.maintenance.format('%h')*60+times.total.maintenance.format('%i') }}
                },
                {
                	name : 'Ateliers / Fournisseurs',
                	color : '#333333',
                	y : {{ times.total.equipment.format('%h')*60+times.total.equipment.format('%i') }}
                }
            ]
        }]
    });

    $('#graphMaintenance').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: 'Entretiens'
        },
        tooltip: {
        	formatter : function(){
                return this.point.name + ': <b>' + this.point.y + '</b>';
            }  
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    formatter: function() {
                    	return '<b>'+ this.point.name +'</b>: '+ Math.round(this.percentage*100)/100 +' %';
                    }
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'Temps passé',
            data: [
                {
                    name : 'Fait',
                    color : '#468847', 
                    y : {{ maintenanceDoes }}
                },
                {
                    name : 'Pas fait',
					color : '#b94a48',
                    y : {{ maintenanceTotal - maintenanceDoes }}
                }
            ]
        }]
    });

    $('#graphEvolution').highcharts('StockChart', {
    	rangeSelector : {
			selected : 1
		},

		title : {
			text : 'Evolution des entretiens'
		},

		series : [{
			name : 'Evolution des entretiens',
			data : [{% for d,data in evolution %}{% if not loop.first %},{% endif %}{ x:{{ d }},y:{{ data }} }{% endfor %} ],
			type : 'area',
			step : true,
			threshold : null
		},
		{
			name : 'Objectifs d\'entretiens',
			data : [{% for d,data in evolutionBase %}{% if not loop.first %},{% endif %}{ x:{{ d }},y:{{ data }} }{% endfor %} ],
			type : 'line',
			threshold : null
			
		},
		]
    });
});
</script>
{% endblock %}