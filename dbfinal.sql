UPDATE site_contacts SET person_id =  51 WHERE person_id IN (192,163,183);
UPDATE site_contacts SET person_id = 435 WHERE person_id IN (492);
UPDATE site_contacts SET person_id = 404 WHERE person_id IN (405);
UPDATE site_contacts SET person_id =  93 WHERE person_id IN (351);
UPDATE site_contacts SET person_id = 324 WHERE person_id IN (362);
UPDATE site_contacts SET person_id = 365 WHERE person_id IN (417);
UPDATE site_contacts SET person_id = 332 WHERE person_id IN (334);
UPDATE site_contacts SET person_id =  21 WHERE person_id IN (186);
UPDATE site_contacts SET person_id =  54 WHERE person_id IN (152,160,172);
UPDATE site_contacts SET person_id = 277 WHERE person_id IN (352);
UPDATE site_contacts SET person_id = 133 WHERE person_id IN (190,198);
UPDATE site_contacts SET person_id = 374 WHERE person_id IN (117,400,361);
UPDATE site_contacts SET person_id = 178 WHERE person_id IN (180);
UPDATE site_contacts SET person_id = 147 WHERE person_id IN (165);
UPDATE site_contacts SET person_id =  27 WHERE person_id IN (312);
UPDATE site_contacts SET person_id = 148 WHERE person_id IN (60);
UPDATE site_contacts SET person_id = 338 WHERE person_id IN (454);
UPDATE site_contacts SET person_id =  14 WHERE person_id IN (47,348,240);
UPDATE site_contacts SET person_id = 437 WHERE person_id IN (137);
UPDATE site_contacts SET person_id =  30 WHERE person_id IN (488);
UPDATE site_contacts SET person_id =  49 WHERE person_id IN (43,162);
UPDATE site_contacts SET person_id = 517 WHERE person_id IN (308);
UPDATE site_contacts SET person_id =  19 WHERE person_id IN (441,442,486);
UPDATE site_contacts SET person_id =  26 WHERE person_id IN (525,458,459);
UPDATE site_contacts SET person_id = 151 WHERE person_id IN (56,170,480);
UPDATE site_contacts SET person_id = 217 WHERE person_id IN (218);
UPDATE site_contacts SET person_id =  52 WHERE person_id IN (161);
UPDATE site_contacts SET person_id =  90 WHERE person_id IN (510);
UPDATE site_contacts SET person_id = 330 WHERE person_id IN (449);
UPDATE site_contacts SET person_id = 445 WHERE person_id IN (501);
UPDATE site_contacts SET person_id =  61 WHERE person_id IN (149);
UPDATE site_contacts SET person_id = 201 WHERE person_id IN (97,203);
UPDATE site_contacts SET person_id = 139 WHERE person_id IN (13);
UPDATE site_contacts SET person_id = 156 WHERE person_id IN (64);
UPDATE site_contacts SET person_id = 259 WHERE person_id IN (262);
UPDATE site_contacts SET person_id = 150 WHERE person_id IN (169);
UPDATE site_contacts SET person_id =  50 WHERE person_id IN (164);
UPDATE site_contacts SET person_id =  44 WHERE person_id IN (358,135);
UPDATE site_contacts SET person_id = 432 WHERE person_id IN (225);
UPDATE site_contacts SET person_id = 319 WHERE person_id IN (320);
UPDATE site_contacts SET person_id =  24 WHERE person_id IN (266);
UPDATE site_contacts SET person_id = 316 WHERE person_id IN (118);
UPDATE site_contacts SET person_id =  71 WHERE person_id IN (176,202);
UPDATE site_contacts SET person_id =  92 WHERE person_id IN (122);
UPDATE site_contacts SET person_id = 490 WHERE person_id IN (491,504);
UPDATE site_contacts SET person_id = 495 WHERE person_id IN (429);
UPDATE quote SET contactPerson_id =  51 WHERE contactPerson_id IN (192,163,183);
UPDATE quote SET contactPerson_id = 435 WHERE contactPerson_id IN (492);
UPDATE quote SET contactPerson_id = 404 WHERE contactPerson_id IN (405);
UPDATE quote SET contactPerson_id =  93 WHERE contactPerson_id IN (351);
UPDATE quote SET contactPerson_id = 324 WHERE contactPerson_id IN (362);
UPDATE quote SET contactPerson_id = 365 WHERE contactPerson_id IN (417);
UPDATE quote SET contactPerson_id = 332 WHERE contactPerson_id IN (334);
UPDATE quote SET contactPerson_id =  21 WHERE contactPerson_id IN (186);
UPDATE quote SET contactPerson_id =  54 WHERE contactPerson_id IN (152,160,172);
UPDATE quote SET contactPerson_id = 277 WHERE contactPerson_id IN (352);
UPDATE quote SET contactPerson_id = 133 WHERE contactPerson_id IN (190,198);
UPDATE quote SET contactPerson_id = 374 WHERE contactPerson_id IN (117,400,361);
UPDATE quote SET contactPerson_id = 178 WHERE contactPerson_id IN (180);
UPDATE quote SET contactPerson_id = 147 WHERE contactPerson_id IN (165);
UPDATE quote SET contactPerson_id =  27 WHERE contactPerson_id IN (312);
UPDATE quote SET contactPerson_id = 148 WHERE contactPerson_id IN (60);
UPDATE quote SET contactPerson_id = 338 WHERE contactPerson_id IN (454);
UPDATE quote SET contactPerson_id =  14 WHERE contactPerson_id IN (47,348,240);
UPDATE quote SET contactPerson_id = 437 WHERE contactPerson_id IN (137);
UPDATE quote SET contactPerson_id =  30 WHERE contactPerson_id IN (488);
UPDATE quote SET contactPerson_id =  49 WHERE contactPerson_id IN (43,162);
UPDATE quote SET contactPerson_id = 517 WHERE contactPerson_id IN (308);
UPDATE quote SET contactPerson_id =  19 WHERE contactPerson_id IN (441,442,486);
UPDATE quote SET contactPerson_id =  26 WHERE contactPerson_id IN (525,458,459);
UPDATE quote SET contactPerson_id = 151 WHERE contactPerson_id IN (56,170,480);
UPDATE quote SET contactPerson_id = 217 WHERE contactPerson_id IN (218);
UPDATE quote SET contactPerson_id =  52 WHERE contactPerson_id IN (161);
UPDATE quote SET contactPerson_id =  90 WHERE contactPerson_id IN (510);
UPDATE quote SET contactPerson_id = 330 WHERE contactPerson_id IN (449);
UPDATE quote SET contactPerson_id = 445 WHERE contactPerson_id IN (501);
UPDATE quote SET contactPerson_id =  61 WHERE contactPerson_id IN (149);
UPDATE quote SET contactPerson_id = 201 WHERE contactPerson_id IN (97,203);
UPDATE quote SET contactPerson_id = 139 WHERE contactPerson_id IN (13);
UPDATE quote SET contactPerson_id = 156 WHERE contactPerson_id IN (64);
UPDATE quote SET contactPerson_id = 259 WHERE contactPerson_id IN (262);
UPDATE quote SET contactPerson_id = 150 WHERE contactPerson_id IN (169);
UPDATE quote SET contactPerson_id =  50 WHERE contactPerson_id IN (164);
UPDATE quote SET contactPerson_id =  44 WHERE contactPerson_id IN (358,135);
UPDATE quote SET contactPerson_id = 432 WHERE contactPerson_id IN (225);
UPDATE quote SET contactPerson_id = 319 WHERE contactPerson_id IN (320);
UPDATE quote SET contactPerson_id =  24 WHERE contactPerson_id IN (266);
UPDATE quote SET contactPerson_id = 316 WHERE contactPerson_id IN (118);
UPDATE quote SET contactPerson_id =  71 WHERE contactPerson_id IN (176,202);
UPDATE quote SET contactPerson_id =  92 WHERE contactPerson_id IN (122);
UPDATE quote SET contactPerson_id = 490 WHERE contactPerson_id IN (491,504);
UPDATE quote SET contactPerson_id = 495 WHERE contactPerson_id IN (429);
DELETE FROM `persons` WHERE id IN (192,163,183,492,405,351,362,417,334,186,152,160,172,352,190,198,117,400,361,180,165,312,60,454,47,348,240,137,488,43,162,308,441,442,486,525,458,459,56,170,480,218,161,510,449,501,149,97,203,13,64,262,169,164,358,135,225,320,266,118,176,202,122,491,504,429);

RENAME TABLE Ride TO rides ;
CREATE TABLE door_managements (id INT AUTO_INCREMENT NOT NULL, trustee_id INT DEFAULT NULL, door_id INT DEFAULT NULL, INDEX IDX_CF925735AFD45F7C (trustee_id), INDEX IDX_CF92573558639EAE (door_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
CREATE TABLE trustee_management_contacts (door_management_id INT NOT NULL, trustee_contact_id INT NOT NULL, INDEX IDX_AA8DA388C0B59545 (door_management_id), INDEX IDX_AA8DA38818CE26B8 (trustee_contact_id), PRIMARY KEY(door_management_id, trustee_contact_id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
CREATE TABLE door_manufacturers (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(255) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
INSERT INTO door_manufacturers (id, name) VALUES (NULL, 'Chronotec'), (NULL, 'Safir'), (NULL, 'Sindaur'), (NULL, 'ESTPM'), (NULL, 'Novoferm'), (NULL, 'Nice'), (NULL, 'Doitrand');
CREATE TABLE trustee_contact_roles (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(255) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
INSERT INTO trustee_contact_roles (id, name) VALUES (NULL, 'Gestionnaire'), (NULL, 'Assistant gestionnaire'),(NULL, 'Compta'),(NULL,'Responsable résidence'),(NULL,'Responsable technique'),(NULL,'Agent de maintenance');
CREATE TABLE site_contact_roles (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(255) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
INSERT INTO site_contact_roles (id, name) VALUES (NULL, 'Gardien'), (NULL, 'Président du Conseil Syndical'), (NULL,'Conseil Syndical')(NULL, 'Copropriétaire'), (NULL, 'Résident');
CREATE TABLE door_models (id INT AUTO_INCREMENT NOT NULL, manufacturer_id INT DEFAULT NULL, type_id INT DEFAULT NULL, name VARCHAR(255) NOT NULL, INDEX IDX_4640DBC7A23B42D (manufacturer_id), INDEX IDX_4640DBC7C54C8C93 (type_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
CREATE TABLE site_contacts_temp (id INT NOT NULL, site_id INT DEFAULT NULL, role_id INT DEFAULT NULL, INDEX IDX_59914838F6BD1646 (site_id), INDEX IDX_59914838D60322AC (role_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
CREATE TABLE trustee_contacts (id INT NOT NULL, trustee_id INT DEFAULT NULL, trole_id INT DEFAULT NULL, INDEX IDX_EA4C19ECAFD45F7C (trustee_id), INDEX IDX_EA4C19EC657BDD1 (trole_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;
ALTER TABLE door_managements ADD CONSTRAINT FK_CF925735AFD45F7C FOREIGN KEY (trustee_id) REFERENCES trustees (id);
ALTER TABLE door_managements ADD CONSTRAINT FK_CF92573558639EAE FOREIGN KEY (door_id) REFERENCES doors (id);
ALTER TABLE trustee_management_contacts ADD CONSTRAINT FK_AA8DA388C0B59545 FOREIGN KEY (door_management_id) REFERENCES door_managements (id);
ALTER TABLE trustee_management_contacts ADD CONSTRAINT FK_AA8DA38818CE26B8 FOREIGN KEY (trustee_contact_id) REFERENCES trustee_contacts (id);
ALTER TABLE door_models ADD CONSTRAINT FK_4640DBC7A23B42D FOREIGN KEY (manufacturer_id) REFERENCES door_manufacturers (id);
ALTER TABLE door_models ADD CONSTRAINT FK_4640DBC7C54C8C93 FOREIGN KEY (type_id) REFERENCES door_types (id);
ALTER TABLE site_contacts_temp ADD CONSTRAINT FK_59914838F6BD1646 FOREIGN KEY (site_id) REFERENCES sites (id);
ALTER TABLE site_contacts_temp ADD CONSTRAINT FK_59914838D60322AC FOREIGN KEY (role_id) REFERENCES site_contact_roles (id);
ALTER TABLE site_contacts_temp ADD CONSTRAINT FK_59914838BF396750 FOREIGN KEY (id) REFERENCES persons (id) ON DELETE CASCADE;
ALTER TABLE trustee_contacts ADD CONSTRAINT FK_EA4C19ECAFD45F7C FOREIGN KEY (trustee_id) REFERENCES trustees (id);
ALTER TABLE trustee_contacts ADD CONSTRAINT FK_EA4C19EC657BDD1 FOREIGN KEY (trole_id) REFERENCES trustee_contact_roles (id);
ALTER TABLE trustee_contacts ADD CONSTRAINT FK_EA4C19ECBF396750 FOREIGN KEY (id) REFERENCES persons (id) ON DELETE CASCADE;
ALTER TABLE rides ADD CONSTRAINT FK_9D4620A37704ED06 FOREIGN KEY (departure_id) REFERENCES doors (id);
ALTER TABLE rides ADD CONSTRAINT FK_9D4620A3816C6140 FOREIGN KEY (destination_id) REFERENCES doors (id);
ALTER TABLE persons DROP FOREIGN KEY FK_A25CC7D3F5B7AF75;
DROP INDEX UNIQ_A25CC7D3F5B7AF75 ON persons;
ALTER TABLE persons DROP address_id;
ALTER TABLE doors ADD model_id INT DEFAULT NULL, ADD modificat TINYINT(1) NOT NULL, ADD series_number VARCHAR(255) NOT NULL;
ALTER TABLE doors ADD CONSTRAINT FK_5E5B762A7975B7E7 FOREIGN KEY (model_id) REFERENCES door_models (id);
CREATE INDEX IDX_5E5B762A7975B7E7 ON doors (model_id);

############################ OK JUSQUICI  ####################################

# Gestionnaires
UPDATE persons SET role = '1' WHERE role IN ('Gestionnaire','Syndic','Inspectrice','Inspecteur');
UPDATE persons SET role = '2' WHERE role IN ('Assistante Copro','Assistante Copriopriétés','Assistante','Assistante Gestionnaire');
UPDATE persons SET role = '3' WHERE role IN ('Comptable','Compta');
UPDATE persons SET role = '4' WHERE role IN ('Responsable résidence','Responsable sur place','Responsable du bâtiment');
UPDATE persons SET role = '5' WHERE role IN ('Responsable technique','Responsable travaux','Service technique');
UPDATE persons SET role = '6' WHERE role IN ('Agent de maintenance');

# Autres
UPDATE persons SET role = 'Gardien' WHERE role IN ('Gardien','Gardienne','Gardien côté ardennes','Gardien côté Adolphe mille','Inspecteur','Agent de secteur');
UPDATE persons SET role = 'Président du Conseil Syndical' WHERE role IN ('Président du Conseil Syndical','Présidente du Conseil Syndical','Présidente Copropriété','Président de la copro','Co-président du conseil syndical');
UPDATE persons SET role = 'Conseil Syndical' WHERE role IN ('Conseil Syndical');
UPDATE persons SET role = 'Copropriétaire' WHERE role IN ('Propriétaire','Copro');
UPDATE persons SET role = 'Résident' WHERE role IN ('Résident','Locataire');

# Contacts syndic
INSERT INTO trustee_contacts (id,trustee_id,trole_id) SELECT persons.id,trustees.id,persons.role FROM persons INNER JOIN site_contacts ON persons.id = site_contacts.person_id LEFT JOIN sites ON sites.id = site_contacts.site_id LEFT JOIN trustees ON trustees.id = sites.trustee_id WHERE persons.role IN ('1','2','3','4','5','6') GROUP BY persons.id;

#

UPDATE persons SET persons.discr = 'trustee_contact' WHERE persons.id = (SELECT trustee_contacts.id FROM trustee_contacts WHERE trustee_contacts.id = persons.id);
INSERT INTO door_managements (id,trustee_id,door_id) SELECT NULL, sites.trustee_id, doors.id FROM doors LEFT JOIN sites ON doors.site_id = sites.id;

# Gardiens
INSERT INTO site_contacts_temp (id, site_id, role_id) SELECT a.person_id,a.site_id,1 FROM site_contacts GROUP BY site_contacts.person_id;
UPDATE persons SET discr = 'site_contact' WHERE persons.id = (SELECT site_contacts_temp.id FROM site_contacts_temp WHERE site_contacts_temp.id = persons.id);

# A la fin
INSERT INTO trustee_management_contacts (door_management_id, trustee_contact_id) SELECT door_managements.id, persons.id FROM door_managements LEFT JOIN doors ON door_managements.door_id = doors.id LEFT JOIN sites ON sites.id = doors.site_id LEFT JOIN site_contacts ON site_contacts.site_id = sites.id LEFT JOIN persons ON persons.id = site_contacts.person_id WHERE persons.discr='trustee_contact';

# On supprime site_contacts et on renomme site_contacts_temp
DROP TABLE site_contacts;
RENAME TABLE site_contacts_temp TO site_contacts ;
